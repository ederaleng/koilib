<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Koinos Library</title>
    <script src="./assets-index/koinos.min.js"></script>
    <link rel="stylesheet" href="./assets-index/prism.css" data-noprefix />
    <link rel="stylesheet" href="./assets-index/main.css" />
  </head>
  <body>
    <script src="assets-index/prism.js"></script>
    <div class="container">
      <h1>Koilib - v2.1.0</h1>
      <h3>Koinos Library for Javascript and Typescript</h3>
      <h3><a href="http://koinos.io">koinos.io</a></h3>

      <p>
        Test it NOW and send a real transaction from your browser! No
        instalation needed
      </p>
      <p>
        Press <span class="key">F12</span>, copy & paste the following code in
        the console and press Enter
      </p>
      <h3>
        <a href="./main.html">Complete documentation can be found here</a>
      </h3>
      <div class="code">
        <pre>
          <code class="language-js">
/**
 * KOILIB - Example for browsers
 *
 * In this example code you will learn how to:
 * - get balance
 * - make a transfer
 * - get mana
 * - get transaction by id
 * - get block
 */

// define signer, provider, and contract
const provider = new Provider([
  "http://api.koinos.io:8080",
  "http://localhost:8080/jsonrpc",
]);
errors=0;
provider.onError = () => { errors++; return errors > 10; }
const privKeyWif = "5HzP7VXcKyzqQu2h42uENEjQMDfNuUk6jLQ57t8rfwNadtxzyqZ";
const signer = Signer.fromWif(privKeyWif);
signer.provider = provider;
const koinContract = new Contract({
  id: "19JntSm8pSNETT9aHTwAUHC5RMoaSmgZPJ",
  abi: utils.Krc20Abi,
  signer,
});
const koin = koinContract.functions;
const myAddress = signer.getAddress();
const receiver = "1BqtgWBcqm9cSZ97avLGZGJdgso7wx6pCA";
let resBalance1, resBalance2, resBalance3, resBalance4;
let resMana1, resMana2, resTransfer;
let blockId, resTx, resBlocks;

(async () => {
  // read the balance of sender
  resBalance1 = await koin.balanceOf({ owner: myAddress });
  console.log(resBalance1);
  bal1 = utils.formatUnits(resBalance1.result.value, 8);
  console.log(`Balance of ${myAddress} is ${bal1} tKoin`);

  // read the balance of receiver
  resBalance2 = await koin.balanceOf({ owner: receiver });
  console.log(resBalance2);
  bal2 = utils.formatUnits(resBalance2.result.value, 8);
  console.log(`Balance of ${receiver} is ${bal2} tKoin`);

  // get mana
  resMana1 = await provider.getAccountRc(myAddress);
  console.log(`Current mana of ${myAddress} is ${resMana1}`);

  // transfer tKoin
  resTransfer = await koin.transfer({
    from: myAddress,
    to: receiver,
    value: utils.parseUnits("0.00000001", 8),
  });
  console.log(resTransfer);
  txId = resTransfer.transaction.id;
  console.log("Transfer submitted to the mempool");
  console.log(`Transaction Id: ${txId}`);
  console.log("Now waiting to be mined...");

  // waiting to be mined
  blockId = await resTransfer.transactionResponse.wait();
  console.log(`Transaction mined in blockId ${blockId}`);

  // the wait() function in the previous step is periodically
  // consulting the transaction by its id
  resTx = await provider.getTransactionsById([txId]);
  console.log(resTx);

  // get block with the transaction
  resBlocks = await provider.getBlocksById([blockId]);
  console.log(resBlocks);
  blockHeight = resBlocks.block_items[0].block_height;
  console.log(`Block number ${blockHeight}`)

  // get new mana
  resMana2 = await provider.getAccountRc(myAddress);
  console.log(`New mana of ${myAddress} is ${resMana2}`);

  // check new balance of sender
  resBalance3 = await koin.balanceOf({ owner: myAddress });
  console.log(resBalance3);
  bal3 = utils.formatUnits(resBalance3.result.value, 8);
  console.log(`New balance of ${myAddress} is ${bal3} tKoin`);

  // check new balance of receiver
  resBalance4 = await koin.balanceOf({ owner: receiver });
  console.log(resBalance4);
  bal4 = utils.formatUnits(resBalance4.result.value, 8);
  console.log(`New balance of ${receiver} is ${bal4} tKoin`);
})();</code>
        </pre>
      </div>
    </div>
  </body>
</html>
